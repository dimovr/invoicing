<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Creation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        @media print {
            .no-print {
                display: none;
            }
        }
        
        .table-bordered th, .table-bordered td {
            border: 1px solid #e2e8f0;
        }
    </style>
</head>
<body class="bg-gray-100">

    <nav class="bg-gray-800 py-4">
        <div class="container mx-auto px-4 mx-auto flex justify-between items-center">
            <div class="flex space-x-4">
                <a href="/company" class="text-white hover:text-gray-300 {{if eq .active "company"}}font-bold border-b-2 border-white{{end}}">Company</a>
                <a href="/items" class="text-white hover:text-gray-300 {{if eq .active "items"}}font-bold border-b-2 border-white{{end}}">Items</a>
                <a href="/suppliers" class="text-white hover:text-gray-300 {{if eq .active "suppliers"}}font-bold border-b-2 border-white{{end}}">Suppliers</a>
                <a href="/invoices" class="text-white hover:text-gray-300 {{if eq .active "invoices"}}font-bold border-b-2 border-white{{end}}">Invoices</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 mx-auto p-4 bg-white shadow-md my-8">
        <!-- Header Section -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div>
                <p class="text-sm">PIB: <span id="pib">{{ .Company.Code }}</span></p>
                <p class="text-sm">Šifra poreskog obveznika: <span id="tax-code">{{ .Company.SectorCode }}</span></p>
                <p class="text-sm">Šifra delatnosti: <span id="activity-code">{{ .Company.Sector }}</span></p>
                <p class="text-sm">Obveznik: <span id="taxpayer">{{ .Company.Name }}</span></p>
                <p class="text-sm">Firma - radnja: <span id="company">{{ .Company.Owner }}</span></p>
                <p class="text-sm">Sedište: <span id="headquarters">{{ .Company.Address }}</span></p>
            </div>
            <div class="text-center">
                <h1 class="text-xl font-bold uppercase">Kalkulacija Prodajne Cene Broj</h1>
                <p class="text-sm mb-4">isporučilac dobara 
                    <select id="supplier-select" class="border rounded p-1" hx-get="/api/suppliers/details" hx-trigger="change" hx-target="#supplier-details" hx-swap="innerHTML">
                        <option value="">Izaberite dobavljača</option>
                        {{ range .Suppliers }}
                        <option value="{{ .ID }}">{{ .Name }} - {{ .Code }} / {{ .Address}}</option>
                        {{ end }}
                    </select>
                    <span id="supplier-details"></span>
                </p>
                <div class="flex justify-center items-center gap-2 mb-4">
                    <p class="text-sm">po dokumentu</p>
                    <select id="document-type" class="px-2 py-1 bg-gray-200 rounded">
                        <option value="faktura">faktura</option>
                        <option value="otpremnica">otpremnica</option>
                        <option value="narudžbenica">narudžbenica</option>
                    </select>
                    <p class="text-sm">broj</p>
                    <input type="text" id="document-number" class="px-2 py-1 bg-gray-200 rounded w-24" placeholder="Broj">
                </div>
                <p class="text-sm">od <span id="invoice-date">{{ .CurrentDate }}</span> godine</p>
            </div>
        </div>

        <!-- Table Section -->
        <div class="overflow-x-auto mb-6">
            <table class="min-w-full table-bordered">
                <thead class="bg-gray-100">
                    <tr class="text-xs">
                        <th class="p-2 text-center">Red. broj</th>
                        <th class="p-2 text-center">Naziv robe</th>
                        <th class="p-2 text-center">Jedinica mere</th>
                        <th colspan="3" class="p-2 text-center">Po fakturi dobavljača</th>
                        <th class="p-2 text-center">Zavisni troškovi</th>
                        <th class="p-2 text-center">Razlika u ceni</th>
                        <th class="p-2 text-center">Prodajna vrednost robe bez PDV (6 + 7 + 8)</th>
                        <th colspan="2" class="p-2 text-center">PDV</th>
                        <th class="p-2 text-center">Prodajna vrednost robe sa obračunatim PDV (9 + 11)</th>
                        <th class="p-2 text-center">Prodajna cena po jedinici mere (12 : 4)</th>
                        <th class="p-2 text-center">Napomena</th>
                    </tr>
                    <tr class="text-xs bg-gray-100">
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center">Količina</th>
                        <th class="p-2 text-center">Cena po jedinici mere</th>
                        <th class="p-2 text-center">Vrednost robe (4 × 5)</th>
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center">Stopa</th>
                        <th class="p-2 text-center">Obračunati iznos</th>
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center"></th>
                    </tr>
                    <tr class="text-xs text-center bg-gray-100">
                        <th class="p-2">1</th>
                        <th class="p-2">2</th>
                        <th class="p-2">3</th>
                        <th class="p-2">4</th>
                        <th class="p-2">5</th>
                        <th class="p-2">6</th>
                        <th class="p-2">7</th>
                        <th class="p-2">8</th>
                        <th class="p-2">9</th>
                        <th class="p-2">10</th>
                        <th class="p-2">11</th>
                        <th class="p-2">12</th>
                        <th class="p-2">13</th>
                        <th class="p-2">14</th>
                    </tr>
                </thead>
                <tbody id="invoice-items">
                    <tr id="item-row-template" class="hidden">
                        <td class="p-2 text-center row-number"></td>
                        <td class="p-2">
                            <select class="w-full border item-selector">
                                <option value="">Proizvod</option>
                                {{ range .Items }}
                                <option value="{{ .ID }}" data-price="{{ .Price }}" data-unit="{{ .Unit }}" data-tax-rate="{{ .TaxRate }}">{{ .Name }}</option>
                                {{ end }}
                            </select>
                        </td>
                        <td class="p-2">
                            <input type="text" class="w-full border-none item-unit" readonly>
                        </td>
                        <td class="p-2">
                            <input type="number" class="w-full border item-quantity" value="1" min="1" step="1">
                        </td>
                        <td class="p-2">
                            <input type="number" step="0.01" class="w-full border item-supplier-price" value="0.00">
                        </td>
                        <td class="p-2 text-right item-supplier-value">0.00</td>
                        <td class="p-2 text-center">
                            <!-- Empty as requested -->
                        </td>
                        <td class="p-2 text-right item-price-difference">0.00</td>
                        <td class="p-2 text-center">
                            <!-- Empty as requested -->
                        </td>
                        <td class="p-2 text-center">
                            <!-- Empty as requested -->
                        </td>
                        <td class="p-2 text-center">
                            <!-- Empty as requested -->
                        </td>
                        <td class="p-2 text-right item-total-price">0.00</td>
                        <td class="p-2 text-right item-unit-price">0.00</td>
                        <td class="p-2">
                            <input type="text" class="w-full border item-note">
                        </td>
                        <!-- Hidden field to store the original price -->
                        <input type="hidden" class="item-original-price">
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5" class="p-2 text-right font-bold">Total:</td>
                        <td class="p-2 text-right font-bold" id="total-supplier-value">0.00</td>
                        <td colspan="5" class="p-2"></td>
                        <td class="p-2 text-right font-bold" id="total-price">0.00</td>
                        <td colspan="2" class="p-2"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Footer Section -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <p class="text-sm">Datum: <span id="document-date">{{ .CurrentDate }}</span> godine</p>
                <p class="text-sm">Sastavio: <span id="prepared-by">{{ .Company.User }}</span></p>
            </div>
            <div class="text-right">
                <p class="text-sm">Odgovorno lice: <span id="responsible-person">{{ .Company.Owner }}</span></p>
            </div>
        </div>

        <!-- Response Message -->
        <div id="response-message" class="mt-4 text-center"></div>

        <!-- Button Section (No Print) -->
        <div class="flex justify-between mt-8 no-print">
            <button id="add-row-btn" class="bg-blue-500 text-white px-4 py-2 rounded">Add Row</button>
            <div>
                <button id="save-btn" class="bg-green-500 text-white px-4 py-2 rounded mr-2" hx-post="/api/invoices" hx-target="#response-message" hx-swap="innerHTML" hx-trigger="click" hx-include="[id='invoice-form']">Save</button>
                <button id="print-btn" class="bg-gray-500 text-white px-4 py-2 rounded">Print</button>
            </div>
        </div>
    </div>

    <form id="invoice-form" class="hidden">
        <input type="hidden" name="company_id" value="{{ .Company.ID }}">
        <input type="hidden" name="supplier_id" id="supplier-id-input">
        <input type="hidden" name="document_type" id="document-type-input">
        <input type="hidden" name="document_number" id="document-number-input">
        <input type="hidden" name="items" id="items-json">
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add first row automatically
            addNewRow();
            
            // Add row button functionality
            document.getElementById('add-row-btn').addEventListener('click', function() {
                addNewRow();
            });
            
            // Print button functionality
            document.getElementById('print-btn').addEventListener('click', function() {
                window.print();
            });
            
            // Save button functionality
            document.getElementById('save-btn').addEventListener('click', function() {
                prepareFormData();
            });
            
            // Listen for supplier change
            document.getElementById('supplier-select').addEventListener('change', function() {
                document.getElementById('supplier-id-input').value = this.value;
            });
            
            // Listen for document type change
            document.getElementById('document-type').addEventListener('change', function() {
                document.getElementById('document-type-input').value = this.value;
            });
            
            // Listen for document number change
            document.getElementById('document-number').addEventListener('input', function() {
                document.getElementById('document-number-input').value = this.value;
            });
        });
        
        function addNewRow() {
            const tbody = document.getElementById('invoice-items');
            const template = document.getElementById('item-row-template');
            const newRow = template.cloneNode(true);
            
            newRow.id = 'item-row-' + (tbody.children.length);
            newRow.classList.remove('hidden');
            
            // Set row number
            newRow.querySelector('.row-number').textContent = tbody.children.length;
            
            // Add event listeners
            addRowEventListeners(newRow);
            
            tbody.appendChild(newRow);
        }
        
        function addRowEventListeners(row) {
            // Item selector change
            const itemSelector = row.querySelector('.item-selector');
            itemSelector.addEventListener('change', function() {
                if (this.value) {
                    const selectedOption = this.options[this.selectedIndex];
                    
                    // Get data from selected option
                    const price = selectedOption.getAttribute('data-price') || '0.00';
                    const unit = selectedOption.getAttribute('data-unit') || '';
                    
                    // Populate fields
                    row.querySelector('.item-unit').value = unit;
                    row.querySelector('.item-original-price').value = price;
                    row.querySelector('.item-unit-price').textContent = price;
                    
                    // Calculate row
                    calculateRow(row);
                    calculateTotals();
                } else {
                    // Reset row if no item selected
                    resetRow(row);
                }
            });
            
            // Quantity change
            row.querySelector('.item-quantity').addEventListener('input', function() {
                calculateRow(row);
                calculateTotals();
            });
            
            // Supplier price change
            row.querySelector('.item-supplier-price').addEventListener('input', function() {
                calculateRow(row);
                calculateTotals();
            });
        }
        
        function resetRow(row) {
            // Reset all input fields
            row.querySelector('.item-unit').value = '';
            row.querySelector('.item-supplier-price').value = '0.00';
            row.querySelector('.item-quantity').value = '1';
            row.querySelector('.item-original-price').value = '0.00';
            row.querySelector('.item-note').value = '';
            
            // Reset calculated fields
            row.querySelector('.item-supplier-value').textContent = '0.00';
            row.querySelector('.item-price-difference').textContent = '0.00';
            row.querySelector('.item-total-price').textContent = '0.00';
            row.querySelector('.item-unit-price').textContent = '0.00';
            
            // Update totals
            calculateTotals();
        }
        
        function calculateRow(row) {
            // Get values from the row
            const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
            const supplierPrice = parseFloat(row.querySelector('.item-supplier-price').value) || 0;
            const originalPrice = parseFloat(row.querySelector('.item-original-price').value) || 0;
            
            // Calculate column 6: Supplier Value (quantity × supplierPrice)
            const supplierValue = quantity * supplierPrice;
            
            // Calculate column 12: Total Price (quantity x originalPrice)
            const totalPrice = quantity * originalPrice;
            
            // Calculate column 8: Price Difference (totalPrice - supplierValue)
            const priceDifference = totalPrice - supplierValue;
            
            // Update the row with calculated values
            row.querySelector('.item-supplier-value').textContent = supplierValue.toFixed(2);
            row.querySelector('.item-price-difference').textContent = priceDifference.toFixed(2);
            row.querySelector('.item-total-price').textContent = totalPrice.toFixed(2);
            row.querySelector('.item-unit-price').textContent = originalPrice.toFixed(2);
        }
        
        function calculateTotals() {
            let totalSupplierValue = 0;
            let totalPrice = 0;
            
            // Sum up all row values
            document.querySelectorAll('#invoice-items tr:not(.hidden)').forEach(row => {
                totalSupplierValue += parseFloat(row.querySelector('.item-supplier-value').textContent) || 0;
                totalPrice += parseFloat(row.querySelector('.item-total-price').textContent) || 0;
            });
            
            // Update totals
            document.getElementById('total-supplier-value').textContent = totalSupplierValue.toFixed(2);
            document.getElementById('total-price').textContent = totalPrice.toFixed(2);
        }
        
        function prepareFormData() {
            // Prepare document info
            document.getElementById('document-type-input').value = document.getElementById('document-type').value;
            document.getElementById('document-number-input').value = document.getElementById('document-number').value;
            document.getElementById('supplier-id-input').value = document.getElementById('supplier-select').value;
            
            // Collect items data
            const items = [];
            document.querySelectorAll('#invoice-items tr:not(.hidden)').forEach(row => {
                const itemSelect = row.querySelector('.item-selector');
                if (itemSelect && itemSelect.value) {
                    items.push({
                        item_id: parseInt(itemSelect.value),
                        quantity: parseFloat(row.querySelector('.item-quantity').value) || 0,
                        supplier_price: parseFloat(row.querySelector('.item-supplier-price').value) || 0,
                        supplier_value: parseFloat(row.querySelector('.item-supplier-value').textContent) || 0,
                        price_difference: parseFloat(row.querySelector('.item-price-difference').textContent) || 0,
                        total_price: parseFloat(row.querySelector('.item-total-price').textContent) || 0,
                        unit_price: parseFloat(row.querySelector('.item-unit-price').textContent) || 0,
                        note: row.querySelector('.item-note').value
                    });
                }
            });
            
            // Set items JSON in the form
            document.getElementById('items-json').value = JSON.stringify(items);
            
            // Form will be submitted by HTMX
        }
    </script>
</body>
</html>
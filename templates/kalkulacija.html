<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulacija</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>        
        .table-bordered th, .table-bordered td {
            border: 1px solid #e2e8f0;
        }
        /* Default styles for non-print */
        body {
            margin: 0;
            padding: 0;
        }
        @media print {
            @page {
                margin: 0;
            }
            /* Hide everything except kalkulacija */
            body > *:not(#kalkulacija) {
                display: none !important;
            }
            #kalkulacija {
                display: block !important;
                position: static; /* Changed from absolute to static for better flow */
                width: 100%;
                margin: 0;
                padding: 10mm;
                box-shadow: none;
            }
            #kalkulacija table {
                width: 100%;
                font-size: 10pt;
                page-break-inside: avoid; /* Prevent table breaking across pages */
            }
            /* Ensure Tailwind classes don't interfere */
            .container, .mx-auto, .my-8, .shadow-md {
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- <nav class="bg-gray-800 py-4">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <div class="flex space-x-4">
                <a href="/company" class="text-white hover:text-gray-300 {{if eq .active "company"}}font-bold border-b-2 border-white{{end}}">Company</a>
                <a href="/items" class="text-white hover:text-gray-300 {{if eq .active "items"}}font-bold border-b-2 border-white{{end}}">Items</a>
                <a href="/suppliers" class="text-white hover:text-gray-300 {{if eq .active "suppliers"}}font-bold border-b-2 border-white{{end}}">Suppliers</a>
                <a href="/invoices" class="text-white hover:text-gray-300 {{if eq .active "invoices"}}font-bold border-b-2 border-white{{end}}">Invoices</a>
            </div>
        </div>
    </nav> -->

    <div id="kalkulacija" class="container mx-auto px-4 p-4 bg-white shadow-md my-8">
        <!-- Header Section -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div>
                <p class="text-sm"><b>PIB:</b> <span id="pib">{{ .Company.Code }}</span></p>
                <p class="text-sm"><b>Šifra poreskog obveznika:</b> <span id="tax-code">{{ .Company.SectorCode }}</span></p>
                <p class="text-sm"><b>Šifra delatnosti:</b> <span id="activity-code">{{ .Company.Sector }}</span></p>
                <p class="text-sm"><b>Obveznik:</b> <span id="taxpayer">{{ .Company.Name }}</span></p>
                <p class="text-sm"><b>Firma - radnja:</b> <span id="company">{{ .Company.Owner }}</span></p>
                <p class="text-sm"><b>Sedište:</b> <span id="headquarters">{{ .Company.Address }}</span></p>
            </div>
            <div class="text-center">
                <h3 class="text-xl font-bold uppercase">Kalkulacija Prodajne Cene #{{ .Invoice.DocumentNumber }}</h3>
                <br>
                <p class="text-sm mb-4"><b>isporučilac dobara: </b> 
                    {{ .Invoice.Supplier.Name }} - {{ .Invoice.Supplier.Code }} / {{ .Invoice.Supplier.Address}}
                </p>
                <p class="text-sm mb-4"><b>od</b> <span id="invoice-date">{{ .Invoice.Date.Format "02.01.2006" }}</span> <b>godine</b></p>
            </div>
        </div>

        <!-- Table Section -->
        <div class="overflow-x-auto mb-6">
            <table class="min-w-full table-bordered">
                <thead class="bg-gray-100">
                    <tr class="text-xs">
                        <th class="p-2 text-center">Red. broj</th>
                        <th class="p-2 text-center">Naziv robe</th>
                        <th class="p-2 text-center">Jedinica mere</th>
                        <th colspan="3" class="p-2 text-center">Po fakturi dobavljača</th>
                        <th class="p-2 text-center">Zavisni troškovi</th>
                        <th class="p-2 text-center">Razlika u ceni</th>
                        <th class="p-2 text-center">Prodajna vrednost robe bez PDV (6 + 7 + 8)</th>
                        <th colspan="2" class="p-2 text-center">PDV</th>
                        <th class="p-2 text-center">Prodajna vrednost robe sa obračunatim PDV (9 + 11)</th>
                        <th class="p-2 text-center">Prodajna cena po jedinici mere (12 : 4)</th>
                        <th class="p-2 text-center">Napomena</th>
                    </tr>
                    <tr class="text-xs bg-gray-100">
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center">Količina</th>
                        <th class="p-2 text-center">Cena po jedinici mere</th>
                        <th class="p-2 text-center">Vrednost robe (4 × 5)</th>
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center">Stopa</th>
                        <th class="p-2 text-center">Obračunati iznos</th>
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center"></th>
                        <th class="p-2 text-center"></th>
                    </tr>
                    <tr class="text-xs text-center bg-gray-100">
                        <th class="p-2">1</th>
                        <th class="p-2">2</th>
                        <th class="p-2">3</th>
                        <th class="p-2">4</th>
                        <th class="p-2">5</th>
                        <th class="p-2">6</th>
                        <th class="p-2">7</th>
                        <th class="p-2">8</th>
                        <th class="p-2">9</th>
                        <th class="p-2">10</th>
                        <th class="p-2">11</th>
                        <th class="p-2">12</th>
                        <th class="p-2">13</th>
                        <th class="p-2">14</th>
                    </tr>
                </thead>
                <tbody id="invoice-items">
                    {{ range $index, $item := .Invoice.LineItems }}
                    <tr>
                        <td class="p-2 text-center">{{ add $index 1 }}</td>
                        <td class="p-2 text-center">{{ $item.Name }}</td>
                        <td class="p-2 text-center">{{ $item.Unit }}</td>
                        <td class="p-2 text-right">{{ printf "%.2f" $item.Quantity }}</td>
                        <td class="p-2 text-right">{{ printf "%.2f" $item.Price }}</td>
                        <td class="p-2 text-right">{{ printf "%.2f" $item.Value }}</td>
                        <td class="p-2 text-right">{{ printf "%.2f" $item.DependentCosts }}</td>
                        <td class="p-2 text-right">{{ printf "%.2f" $item.PriceDifference }}</td>
                        <td class="p-2 text-right">{{ printf "%.2f" $item.ValueWithoutVat }}</td>
                        <td class="p-2 text-center">{{ printf "%.2f" $item.VatRate }}</td>
                        <td class="p-2 text-right">{{ printf "%.2f" $item.VatAmount }}</td>
                        <td class="p-2 text-right">{{ printf "%.2f" $item.ValueWithVat }}</td>
                        <td class="p-2 text-right">{{ printf "%.2f" $item.UnitPrice }}</td>
                        <td class="p-2 text-center">{{ $item.Note }}</td>
                    </tr>
                    {{ end }}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="5" class="p-2 text-right font-bold">Total:</td>
                        <td class="p-2 text-right font-bold">{{ printf "%.2f" .Invoice.Subtotal }}</td>
                        <td colspan="5" class="p-2"></td>
                        <td class="p-2 text-right font-bold">{{ printf "%.2f" .Invoice.Total }}</td>
                        <td colspan="2" class="p-2"></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Footer Section -->
        <div class="grid grid-cols-2 gap-4">
            <div>
                <p class="text-sm"><b>Datum:</b> <span id="document-date">{{ .CurrentDate }}</span> godine</p>
                <p class="text-sm"><b>Sastavio:</b> <span id="prepared-by">{{ .Company.User }}</span></p>
            </div>
            <div class="text-right">
                <p class="text-sm"><b>Odgovorno lice:</b> <span id="responsible-person">{{ .Company.Owner }}</span></p>
            </div>
        </div>
    </div>

    <button id="print-btn" class="bg-gray-500 text-white px-4 py-2 rounded w-full">
        Print
    </button>

    <script>
        // document.getElementById('print-btn').addEventListener('click', function() {
        //     window.print();
        // });
    document.getElementById('print-btn').addEventListener('click', function() {
        // Get the kalkulacija content
        const kalkulacijaContent = document.getElementById('kalkulacija').outerHTML;
        
        // Create a new window for printing
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>Kalkulacija #{{ .Invoice.DocumentNumber }}</title>
                <style>
                    body { margin: 0; padding: 10mm; font-family: Arial, sans-serif; }
                    .table-bordered th, .table-bordered td { border: 1px solid #e2e8f0; }
                    table { width: 100%; font-size: 10pt; }
                    .grid { display: grid; }
                    .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
                    .gap-4 { gap: 1rem; }
                    .text-center { text-align: center; }
                    .text-right { text-align: right; }
                    .mb-6 { margin-bottom: 1.5rem; }
                    .text-sm { font-size: 0.875rem; }
                    .font-bold { font-weight: bold; }
                </style>
            </head>
            <body>
                ${kalkulacijaContent}
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    });
    </script>
</body>
</html>